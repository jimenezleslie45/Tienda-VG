<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Variedades Garc√≠a</title>

<style>
:root {
    --primary: #b5b1ee;
    --accent: #90bedd;
    --bg: #f4f7f6;
    --text: #2c3e50;
    --white: #fff;
    --success: #27ae60;
    --footer: #34495e;
}

body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    color: var(--text);
}

header {
    background: linear-gradient(135deg, var(--primary) 0%, rgba(255,255,255,0.1) 50%, var(--accent) 100%);
    text-align: center;
    padding: 30px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.header-logo {
    width: 140px;
    height: 140px;
    object-fit: cover;
    clip-path: circle(50%);
}

.whatsapp-link {
    display: inline-block;
    margin-top: 15px;
    padding: 10px 25px;
    background: var(--success);
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: bold;
}

.container {
    max-width: 1100px;
    margin: 30px auto;
    padding: 0 20px;
}

.section {
    background: white;
    padding: 25px;
    margin-bottom: 30px;
    border-radius: 10px;
}

.section h2 {
    border-left: 5px solid var(--accent);
    padding-left: 10px;
}

.upload-form input,
.upload-form button {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
}

.upload-form button {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
}

.products {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
}

.product {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}

.product img {
    width: 100%;
    height: auto;
    max-height: 260px;
    object-fit: contain;
    background: #f4f4f4;
    border-radius: 8px;
}




.product button {
    margin-top: 10px;
    width: 100%;
    padding: 10px;
    background: var(--primary);
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.inventory, .sales {
    background: #ecf0f1;
    padding: 20px;
    border-radius: 8px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 10px;
    border-bottom: 1px solid #ccc;
}

th {
    background: var(--accent);
    color: white;
}

footer {
    background: var(--footer);
    color: white;
    text-align: center;
    padding: 30px;
}

/* Responsive Design */
@media (max-width: 768px) {
    header {
        padding: 20px;
    }

    .header-logo {
        width: 100px;
        height: 100px;
    }

    h1 {
        font-size: 2em !important;
    }

    p {
        font-size: 1em !important;
    }

    .container {
        padding: 0 10px;
    }

    .section {
        padding: 15px;
    }

    .products {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .product {
        padding: 10px;
    }

    .grid-2 {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .upload-form input,
    .upload-form button {
        padding: 10px;
    }

    .product button {
        padding: 8px;
        font-size: 14px;
    }

    table, th, td {
        font-size: 14px;
        padding: 8px;
    }
}

@media (max-width: 480px) {
    header {
        padding: 15px;
    }

    .header-logo {
        width: 80px;
        height: 80px;
    }

    h1 {
        font-size: 1.5em !important;
    }

    p {
        font-size: 0.9em !important;
    }

    .section {
        padding: 10px;
        margin-bottom: 20px;
    }

    .products {
        gap: 10px;
    }

    .product img {
        max-height: 200px;
    }

    .product button {
        padding: 6px;
        font-size: 12px;
    }

    .inventory, .sales {
        padding: 15px;
    }

    footer {
        padding: 20px;
    }
}
</style>
</head>

<body>

<header>
    <img src="imagen/Logo1.jpg" class="header-logo">
    <h1 style="font-family: 'Georgia', serif; font-size: 2.5em; font-weight: bold; color: var(--text);">Variedades Garc√≠a</h1>
    <p style="font-family: 'Georgia', serif; font-size: 1.2em; color: var(--text);">Todos nuestros productos son de alta calidad y extra√≠dos de USA</p>
    <a class="whatsapp-link" href="https://wa.me/44969900" target="_blank">
        Escr√≠benos por WhatsApp
    </a>
</header>

<div class="container">

<button type="button" onclick="loginAdmin()" id="adminButton">Modo Admin</button>

<!-- PANEL ADMIN -->
<div class="section" id="adminPanel" style="display:none">
<h2>Panel de Administraci√≥n</h2>
<form id="uploadForm" class="upload-form">
    <input type="text" id="productName" placeholder="Nombre del producto">
    <input type="number" id="productPrice" placeholder="Precio">
    <input type="number" id="productQuantity" placeholder="Cantidad">
    <input type="file" id="productImage" accept="image/*">

    <button type="submit">Publicar Producto</button>
</form>
</div>

<!-- CATALOGO -->
<div class="section">
<h2>Cat√°logo de Productos</h2>
<div id="productsContainer" class="products"></div>
</div>

<!-- INVENTARIO Y VENTAS -->
<div class="section">
<h2>Inventario y Ventas</h2>

<div class="grid-2">
    <div class="inventory">
        <h3>Inventario</h3>
        <ul id="inventoryList"></ul>
    </div>

    <div class="sales">
        <h3>Ventas</h3>
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody id="salesTable"></tbody>
        </table>
    </div>
</div>
</div>

</div>

<footer>
<p>&copy; 2026 Variedades Garc√≠a</p>
</footer>

<script>
// IndexedDB setup
let db;
const dbName = 'TiendaDB';
const productsStore = 'products';
const salesStore = 'sales';

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(productsStore)) {
                db.createObjectStore(productsStore, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(salesStore)) {
                db.createObjectStore(salesStore, { keyPath: 'id', autoIncrement: true });
            }
        };
    });
}

async function loadData() {
    await openDB();
    products = await getAll(productsStore);
    sales = await getAll(salesStore);
}

function getAll(storeName) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function saveItem(storeName, item) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(item);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

function deleteItem(storeName, id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

let products = [];
let sales = [];
let isAdmin = false;

// Load data on page load
loadData().then(() => {
    renderProducts();
    renderInventory();
    renderSales();
});

function loginAdmin() {
    if (!isAdmin) {
        const password = prompt("Contrase√±a de admin:");
        if (password === "admin2026") { // Cambia esta contrase√±a por una segura
            isAdmin = true;
            document.getElementById("adminPanel").style.display = "block";
            document.querySelector("button[onclick='loginAdmin()']").textContent = "Salir Admin";
        } else {
            alert("Contrase√±a incorrecta");
        }
    } else {
        isAdmin = false;
        document.getElementById("adminPanel").style.display = "none";
        document.querySelector("button[onclick='loginAdmin()']").textContent = "Modo Admin";
    }
}

function renderProducts() {
    const container = document.getElementById("productsContainer");
    container.innerHTML = "";

    if (products.length === 0) {
        container.innerHTML = "<p>No hay productos.</p>";
        return;
    }

    products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
            <img src="${p.image}">
            <h3>${p.name}</h3>
            <p>Q${p.price}</p>
            <p>Stock: ${p.quantity}</p>
            <button onclick="sellProduct(${p.id})">Comprar</button>
        `;
        if (isAdmin) {
            div.innerHTML += `<button onclick="editProduct(${p.id})">Editar</button><button onclick="deleteProduct(${p.id})">Eliminar</button>`;
            if (p.quantity === 0) {
                div.innerHTML += `<button onclick="deleteSoldProduct(${p.id})" style="background:red;">Eliminar Vendido</button>`;
            }
        }
        container.appendChild(div);
    });
}

function renderInventory() {
    const list = document.getElementById("inventoryList");
    list.innerHTML = "";
    if (!isAdmin) {
        list.innerHTML = "<li>Solo para administradores</li>";
        return;
    }
    products.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name}: ${p.quantity}`;
        list.appendChild(li);
    });
}

function renderSales() {
    const table = document.getElementById("salesTable");
    table.innerHTML = "";
    sales.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.name}</td><td>${s.date}</td>`;
        table.appendChild(tr);
    });
}

async function sellProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product || product.quantity <= 0) {
        alert("Producto agotado");
        return;
    }

    product.quantity--;
    await saveItem(productsStore, product);
    await saveItem(salesStore, {
        name: product.name,
        date: new Date().toLocaleDateString()
    });

    products = await getAll(productsStore);
    sales = await getAll(salesStore);

    renderProducts();
    renderInventory();
    renderSales();

    const msg = `¬°Hola, Variedades Garc√≠a! üëãüåüMe gustar√≠a solicitar informaci√≥n o comprar el siguiente producto ${product.name} por Q${product.price}`;
    window.open(`https://wa.me/44969900?text=${encodeURIComponent(msg)}`, "_blank");
}

async function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    const newName = prompt("Nuevo nombre:", product.name);
    const newPrice = prompt("Nuevo precio:", product.price);
    const newQuantity = prompt("Nueva cantidad:", product.quantity);
    if (newName !== null) product.name = newName;
    if (newPrice !== null) product.price = parseFloat(newPrice) || product.price;
    if (newQuantity !== null) product.quantity = parseInt(newQuantity) || product.quantity;
    await saveItem(productsStore, product);
    products = await getAll(productsStore);
    renderProducts();
    renderInventory();
}

async function deleteProduct(id) {
    if (confirm("¬øEliminar este producto?")) {
        await deleteItem(productsStore, id);
        products = await getAll(productsStore);
        renderProducts();
        renderInventory();
    }
}

async function deleteSoldProduct(id) {
    if (confirm("¬øEliminar este producto vendido?")) {
        await deleteItem(productsStore, id);
        products = await getAll(productsStore);
        renderProducts();
        renderInventory();
    }
}

document.getElementById("uploadForm").addEventListener("submit", function(e) {
    e.preventDefault();
    console.log("Form submitted, isAdmin:", isAdmin);
    if (!isAdmin) {
        alert("Solo el administrador puede publicar productos");
        return;
    }

    const name = productName.value || "Producto sin nombre";
    const price = productPrice.value || 0;
    const quantity = productQuantity.value || 0;
    const files = productImage.files;
    console.log("Files selected:", files.length);

    if (files.length === 0) {
        alert("Selecciona al menos una imagen");
        return;
    }

    let processed = 0;
    const total = files.length;

    const save = async (img, index) => {
        const product = {
            id: Date.now() + index,
            name: total > 1 ? `${name} ${index + 1}` : name,
            price,
            quantity,
            image: img
        };
        products.push(product);
        processed++;
        // Guardar inmediatamente en IndexedDB despu√©s de cada imagen procesada
        try {
            await saveItem(productsStore, product);
            products = await getAll(productsStore);
            renderProducts();
            renderInventory();
        } catch (e) {
            alert("Error al guardar el producto: " + e.message);
            // Revertir el push si no se pudo guardar
            products.pop();
            processed--;
            return;
        }
        if (processed === total) {
            this.reset();
        }
    };

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = (e) => save(e.target.result, i);
        reader.readAsDataURL(file);
    }
});

renderProducts();
renderInventory();
renderSales();
</script>

</body>
</html>
